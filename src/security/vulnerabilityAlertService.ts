/**
 * Vulnerability Alert Service for CashTrace Security & Compliance Module.
 *
 * Monitors scan results for critical/high severity vulnerabilities and
 * generates alerts. Tracks alert status and ensures alerts are created
 * within 24 hours of detection.
 *
 * @module security/vulnerabilityAlertService
 *
 * Requirement 9.2: Alert on critical vulnerabilities within 24 hours.
 */

import { randomUUID } from 'node:crypto';
import type {
  AlertChannel,
  AlertRecipient,
  AlertStatus,
  ScanResult,
  Vulnerability,
  VulnerabilityAlert,
  VulnerabilitySeverity,
} from './types.js';

/** Maximum time (ms) between detection and alert creation – 24 hours. */
const ALERT_DEADLINE_MS = 24 * 60 * 60 * 1000;

/** Severity levels that trigger alerts. */
const ALERTABLE_SEVERITIES: ReadonlySet<VulnerabilitySeverity> = new Set(['critical', 'high']);

export class VulnerabilityAlertService {
  /** In-memory alert store keyed by alert id. */
  private readonly alerts = new Map<string, VulnerabilityAlert>();

  /** In-memory recipient store keyed by recipient id. */
  private readonly recipients = new Map<string, AlertRecipient>();

  /**
   * Track which vulnerabilities already have an alert so we don't duplicate.
   * Key format: `${vulnerabilityId}:${affectedPackage}:${version}`
   */
  private readonly alertedVulnerabilities = new Set<string>();

  // ─── Recipient Management ───

  /**
   * Add a recipient to receive vulnerability alerts.
   */
  addRecipient(name: string, channel: AlertChannel, destination: string): AlertRecipient {
    const recipient: AlertRecipient = {
      id: randomUUID(),
      name,
      channel,
      destination,
    };
    this.recipients.set(recipient.id, recipient);
    return recipient;
  }

  /**
   * Remove a recipient by id. Returns true if removed.
   */
  removeRecipient(recipientId: string): boolean {
    return this.recipients.delete(recipientId);
  }

  /**
   * Get all configured recipients.
   */
  getRecipients(): AlertRecipient[] {
    return [...this.recipients.values()];
  }

  // ─── Alert Generation ───

  /**
   * Process scan results and generate alerts for critical/high vulnerabilities.
   *
   * Returns the list of newly created alerts.
   *
   * Requirement 9.2: Alert on critical vulnerabilities within 24 hours.
   */
  processScanResults(scanResult: ScanResult, now: Date = new Date()): VulnerabilityAlert[] {
    const newAlerts: VulnerabilityAlert[] = [];

    for (const vuln of scanResult.vulnerabilitiesFound) {
      if (!ALERTABLE_SEVERITIES.has(vuln.severity)) {
        continue;
      }

      const vulnKey = `${vuln.id}:${vuln.affectedPackage}:${vuln.version}`;
      if (this.alertedVulnerabilities.has(vulnKey)) {
        continue;
      }

      const alert = this.createAlert(vuln, now);
      newAlerts.push(alert);
    }

    return newAlerts;
  }

  /**
   * Create an alert for a single vulnerability.
   */
  private createAlert(vuln: Vulnerability, now: Date): VulnerabilityAlert {
    const recipientIds = [...this.recipients.keys()];

    const alert: VulnerabilityAlert = {
      id: randomUUID(),
      vulnerabilityId: vuln.id,
      severity: vuln.severity,
      status: 'pending',
      createdAt: now,
      recipientIds,
      message: `${vuln.severity.toUpperCase()} vulnerability detected: ${vuln.name} in ${vuln.affectedPackage}@${vuln.version}${vuln.fixVersion ? ` (fix: ${vuln.fixVersion})` : ''}`,
    };

    this.alerts.set(alert.id, alert);
    this.alertedVulnerabilities.add(`${vuln.id}:${vuln.affectedPackage}:${vuln.version}`);

    return alert;
  }

  // ─── Alert Status Management ───

  /**
   * Mark an alert as sent.
   */
  markSent(alertId: string, now: Date = new Date()): VulnerabilityAlert | undefined {
    const alert = this.alerts.get(alertId);
    if (!alert) return undefined;

    const updated: VulnerabilityAlert = { ...alert, status: 'sent', sentAt: now };
    this.alerts.set(alertId, updated);
    return updated;
  }

  /**
   * Mark an alert as acknowledged.
   */
  markAcknowledged(alertId: string, now: Date = new Date()): VulnerabilityAlert | undefined {
    const alert = this.alerts.get(alertId);
    if (!alert) return undefined;

    const updated: VulnerabilityAlert = { ...alert, status: 'acknowledged', acknowledgedAt: now };
    this.alerts.set(alertId, updated);
    return updated;
  }

  // ─── Alert Queries ───

  /**
   * Get all alerts, optionally filtered by status.
   */
  getAlerts(status?: AlertStatus): VulnerabilityAlert[] {
    const all = [...this.alerts.values()];
    if (status) {
      return all.filter((a) => a.status === status);
    }
    return all;
  }

  /**
   * Get all pending alerts (not yet sent).
   */
  getPendingAlerts(): VulnerabilityAlert[] {
    return this.getAlerts('pending');
  }

  /**
   * Check whether an alert was created within 24 hours of the vulnerability's detection.
   *
   * Requirement 9.2: Alert on critical vulnerabilities within 24 hours.
   */
  isAlertWithinDeadline(alert: VulnerabilityAlert, detectedAt: Date): boolean {
    return alert.createdAt.getTime() - detectedAt.getTime() <= ALERT_DEADLINE_MS;
  }
}
